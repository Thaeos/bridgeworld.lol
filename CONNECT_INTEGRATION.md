# Connect page — MetaMask SDK + signature.js + Safe{Wallet} + WalletConnect

The connect flow is wired to the same stack as the framework: **WalletConnect Kit → MetaMask SDK → Safe{Wallet} → Diamond**.

**Primary account:** Single primary account defaults to ENS `theosmagic.uni.eth` and email `theosmagic.uni.eth@ethermail.io` (sole signer). MetaMask is the all-in-one; Safe{Wallet} (Safe.global, post-Gnosis) is the contract layer for Treasure DAO fren + Elima agent wallets — agent can execute purchases relayed from you only after you approve via Safe. Safe’s **programmable bot system** (docs.safe.global: AI agents, human approval) matches this flow. See repo root **PRIMARY_ACCOUNT_AND_SAFE.md** and **METAMASK_SDK_AND_SAFE_GLOBAL_RESEARCH.md**.

## What’s integrated

| Piece | Where | How |
|-------|--------|-----|
| **MetaMask SDK** | connect.html | Module script loads `@metamask/sdk` (esm.sh), inits, sets `window.__METAMASK_PROVIDER__`. Connect + balance use this provider (fallback: `window.ethereum`). |
| **Manifest** | connect.html | Fetches `./manifest/framework-manifest.json` (from `npm run generate-manifest`; copied to bridgeworld.lol/manifest/). Chain names come from manifest; fallback to hardcoded. |
| **signature.js** | js/signature.js | `signInToBridgeworld(provider, address)` — `personal_sign` for “Sign in to Bridgeworld”. Connect page Sign button uses it (or inline fallback). |
| **Safe{Wallet}** | connect.html | “Safe{Wallet}” section: input Safe address, “Load Safe” fetches Safe API (`safe-transaction-arbitrum.safe.global`), shows threshold, owners, nonce; if wallet connected, shows Safe balance via `eth_getBalance`. Same stack as `metamask_safe_integration.ts`. |
| **WalletConnect** | connect.html | Button explains: WalletConnect Kit → MetaMask SDK → Safe → Diamond. Set `window.__WALLETCONNECT_PROJECT_ID__` (from cloud.walletconnect.com) to enable modal; otherwise use `npm run walletconnect -- connect` (Node). Same stack as `walletconnect_kit_integration.ts`. |

## Flow

1. **Chains** — From `manifest/framework-manifest.json` (generated by framework; `npm run generate-manifest` copies to bridgeworld.lol).
2. **Connect** — MetaMask SDK provider or `window.ethereum`; ethers Web3Provider; live balance read.
3. **Sign in** — `js/signature.js` `signInToBridgeworld(provider, address)` or inline `personal_sign`.
4. **Safe** — Enter Safe address → Load Safe → Safe API + (if connected) Safe balance.
5. **WalletConnect** — Project ID required for in-browser modal; CLI: `npm run walletconnect -- connect`.

## Bots / automation

Safe status and propose flows live in the framework: `npm run metamask-safe -- status --safe <address>`, `npm run metamask-safe -- propose ...`, `npm run walletconnect -- inject-diamonds --safe <address>`. Connect page is the browser slice of the same stack; bots/automation use the Node scripts.
